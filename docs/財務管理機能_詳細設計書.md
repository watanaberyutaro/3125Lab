# 財務管理機能 詳細設計書

## 1. 概要
3125Labプロジェクト管理システムに財務管理機能を追加し、プロジェクトごとの収支管理を可能にする。

## 2. 機能要件

### 2.1 プロジェクト財務情報
プロジェクトに以下の財務情報を追加：

#### 収入項目
- **制作費用** (development_fee)
  - 初期開発費用
  - 一括請求額
  - 型: number (円)
  
- **月額収入** (monthly_revenue)
  - クライアントから受け取る月額費用
  - サブスクリプション料金、保守費用など
  - 型: number (円/月)

#### 支出項目
- **月額支出** (monthly_cost)
  - サーバー費用
  - ドメイン費用
  - その他の維持費
  - 型: number (円/月)

#### 計算項目
- **月額利益** (monthly_profit)
  - 計算式: monthly_revenue - monthly_cost
  - 自動計算
  
- **年間利益予測** (annual_profit_forecast)
  - 計算式: monthly_profit × 12
  - 自動計算

## 3. データベース設計

### 3.1 projects_v2テーブル拡張
```sql
ALTER TABLE projects_v2 ADD COLUMN development_fee DECIMAL(15, 2) DEFAULT 0;
ALTER TABLE projects_v2 ADD COLUMN monthly_revenue DECIMAL(15, 2) DEFAULT 0;
ALTER TABLE projects_v2 ADD COLUMN monthly_cost DECIMAL(15, 2) DEFAULT 0;
```

### 3.2 財務履歴テーブル (finance_history_v2)
収支の変更履歴を管理
```sql
CREATE TABLE finance_history_v2 (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  project_id UUID REFERENCES projects_v2(id) ON DELETE CASCADE,
  type VARCHAR(50) NOT NULL, -- 'revenue', 'cost', 'development_fee'
  amount DECIMAL(15, 2) NOT NULL,
  description TEXT,
  recorded_date DATE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 4. UI/UX設計

### 4.1 プロジェクト作成・編集フォーム
ProjectFormコンポーネントに以下のフィールドを追加：

```
[財務情報]
┌─────────────────────────────────────┐
│ 制作費用（一括）                    │
│ [___________] 円                    │
│                                     │
│ 月額収入（クライアント）            │
│ [___________] 円/月                 │
│                                     │
│ 月額支出（維持費）                  │
│ [___________] 円/月                 │
│                                     │
│ 月額利益: ¥XX,XXX                  │
│ 年間利益予測: ¥X,XXX,XXX           │
└─────────────────────────────────────┘
```

### 4.2 財務管理ダッシュボード (/finance)
新規ページとして作成

#### 4.2.1 サマリーカード
```
┌──────────────┬──────────────┬──────────────┬──────────────┐
│ 総月額収入   │ 総月額支出   │ 月額利益     │ 年間利益予測 │
│ ¥XXX,XXX     │ ¥XXX,XXX     │ ¥XXX,XXX     │ ¥X,XXX,XXX   │
└──────────────┴──────────────┴──────────────┴──────────────┘
```

#### 4.2.2 プロジェクト別収支表
```
┌─────────────────────────────────────────────────────────────┐
│ プロジェクト名 │ 制作費  │ 月額収入 │ 月額支出 │ 月額利益  │
├─────────────────────────────────────────────────────────────┤
│ プロジェクトA  │ ¥500K   │ ¥30K    │ ¥10K    │ ¥20K     │
│ プロジェクトB  │ ¥300K   │ ¥50K    │ ¥15K    │ ¥35K     │
└─────────────────────────────────────────────────────────────┘
```

#### 4.2.3 収支グラフ
- 月別収支推移（折れ線グラフ）
- プロジェクト別収益構成（円グラフ）
- 支出内訳（棒グラフ）

### 4.3 プロジェクト詳細画面
財務情報セクションを追加：

```
┌─────────────────────────────────────┐
│ 財務情報                            │
├─────────────────────────────────────┤
│ 制作費用: ¥500,000                 │
│ 月額収入: ¥30,000                  │
│ 月額支出: ¥10,000                  │
│ ──────────────────                 │
│ 月額利益: ¥20,000                  │
│ 年間利益: ¥240,000                 │
│                                     │
│ 運用期間: 6ヶ月                    │
│ 累計収益: ¥680,000                 │
└─────────────────────────────────────┘
```

## 5. 実装計画

### Phase 1: データベース拡張
1. projects_v2テーブルにカラム追加
2. finance_history_v2テーブル作成
3. Supabase TypeScript型定義更新

### Phase 2: プロジェクト機能拡張
1. ProjectFormコンポーネント更新
   - 財務情報入力フィールド追加
   - リアルタイム利益計算
2. プロジェクト詳細画面に財務情報表示
3. プロジェクト一覧に月額利益表示

### Phase 3: 財務管理ページ作成
1. /finance ルート作成
2. 財務ダッシュボード実装
   - サマリー統計
   - プロジェクト別収支表
   - フィルタリング機能
3. エクスポート機能（CSV/PDF）

### Phase 4: 高度な機能
1. 収支予測機能
2. アラート機能（赤字プロジェクト警告）
3. 財務レポート自動生成

## 6. セキュリティ考慮事項
- 財務情報へのアクセス制御
- 金額データの暗号化
- 監査ログの実装

## 7. パフォーマンス考慮事項
- 集計データのキャッシング
- インデックスの適切な設定
- ページネーション実装

## 8. テスト計画
- 金額計算の精度テスト
- エッジケース（0円、マイナス値）
- 大量データでのパフォーマンステスト

## 9. 今後の拡張案
- 請求書自動生成
- 支払いリマインダー
- 外部会計システム連携
- 税金計算機能
- 複数通貨対応